<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Samiran — Start</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
   /* ===== Root tokens ===== */
:root{
  --glass: rgba(255,255,255,.06);
  --glass-strong: rgba(255,255,255,.10);
  --text: #EDEDED;
  --muted: #A1A1AA;
  --ring: rgba(165,120,255,.35);
  --radius: 22px;
  --shadow-1: 0 18px 60px rgba(0,0,0,.55);
  --shadow-2: inset 0 1px 0 rgba(255,255,255,.05);
  --pane-h: clamp(380px, 56vh, 560px);
}

/* ===== Global & stability ===== */
*{ box-sizing:border-box }
html,body{ height:100% }
html{
  scrollbar-gutter: stable both-edges; /* prevent layout width shifting when scrollbars appear */
}
body{
  margin:0; color:var(--text);
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
  background:#000; min-height:100dvh; overflow-x:hidden;
  overflow-y: scroll; /* reserve vertical scrollbar space for stability */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== Soft dark mist ===== */
.stellar{
  position:fixed; inset:0; z-index:-1;
  background:
    radial-gradient(ellipse 140% 60% at 15% 60%, rgba(68, 51, 122, 0.15), transparent 60%),
    radial-gradient(ellipse 100% 70% at 80% 25%, rgba(85, 120, 180, 0.12), transparent 60%),
    radial-gradient(ellipse 120% 75% at 40% 90%, rgba(60, 80, 110, 0.10), transparent 60%),
    radial-gradient(ellipse 100% 50% at 70% 10%, rgba(45, 65, 95, 0.12), transparent 60%),
    radial-gradient(ellipse 90% 75% at 90% 80%, rgba(100, 70, 160, 0.10), transparent 55%),
    #0a0a0f;
  background-size:200% 200%;
  animation: mistMove 16s ease-in-out infinite alternate;
  filter: blur(2px) brightness(.95) saturate(1.1);
}
@keyframes mistMove{ 0%{background-position:0% 50%} 100%{background-position:100% 50%} }

/* ===== Stage ===== */
.stage{ min-height:100dvh; display:grid; place-items:center; padding:70px 24px 70px; }
.stack{ width:min(1180px,94vw); display:grid; gap:22px; grid-template-rows:auto auto; }

/* ===== Greeting ===== */
.greet{
  justify-self:center; text-align:center; font-weight:800; letter-spacing:.2px;
  font-size:clamp(36px,6.2vw,64px); line-height:1.07;
  background:linear-gradient(90deg,#ffb300,#ff6b6b,#7c3aed,#22d3ee,#34d399,#ffb300);
  background-size:250% 100%; -webkit-background-clip:text; color:transparent;
  animation: brandFlow 10s ease-in-out infinite;
}
@keyframes brandFlow{ 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

/* ===== Content layout: fixed left ~33.33%, fluid right ===== */
.content{
  display:grid; gap:20px; align-items:stretch;
  grid-template-columns: minmax(320px, 33.33%) 1fr; /* fixed-left, fluid-right */
}
@media (max-width:980px){
  .content{ grid-template-columns:1fr }
  .pane{ min-height:auto; height:auto }
}

.card{ background:var(--glass); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow-1),var(--shadow-2); backdrop-filter:blur(12px) }
.pane{ min-height:var(--pane-h); display:flex; flex-direction:column }
@media (min-width:981px){ .pane{ height:var(--pane-h) } } /* equal height */

/* Ensure stable widths for columns */
.clock-card{ flex:0 0 auto; min-width:300px; }
.panel{ min-width:0; } /* prevent overflow from long content on right */

/* ===== Clock ===== */
.clock-card{ padding:18px; align-items:center; justify-content:center; gap:8px }
.dial-wrap{ width:100%; display:grid; place-items:center }
canvas#dial{ width:min(320px,88%); aspect-ratio:1/1; height:auto; border-radius:18px; filter: drop-shadow(0 14px 30px rgba(0,0,0,.45)) }
.digital{ font-weight:800; font-size:18px; letter-spacing:.6px; margin-top:2px }
.date{ color:var(--muted); font-size:14px; letter-spacing:.3px; margin-top:2px }

/* ===== Search ===== */
.panel{ padding:18px; gap:14px; position:relative }
.searchbar{ position:relative; } /* containing block for suggestions */
.field{ display:flex; align-items:center; gap:12px; border-radius:18px; padding:12px;
  background:var(--glass-strong); border:1px solid rgba(255,255,255,.10); box-shadow:var(--shadow-1),var(--shadow-2); transition:.25s }
.field:focus-within{ box-shadow:0 0 0 3px var(--ring), var(--shadow-1); transform:translateY(-1px); background:rgba(255,255,255,.14); will-change: transform; }
.field .icon{ width:22px; height:22px; opacity:.9 }
input#q{ flex:1; font-size:16px; color:var(--text); background:transparent; border:none; outline:none; padding:8px 2px; min-width:0; }
.ai-btn{ border:none; cursor:pointer; padding:10px 18px; border-radius:999px; font-weight:700; color:#0b0b0b; background:linear-gradient(90deg,#a78bfa,#60a5fa); box-shadow:0 8px 24px rgba(96,165,250,.35) }

/* ===== Top-right Kebab ===== */
.kebab{ position:fixed; top:14px; right:14px; z-index:9999; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:700; font-size:14px; color:var(--text) }
.kebab:hover{ background:rgba(255,255,255,.12) }
.menu{ position:fixed; right:14px; top:48px; display:none; min-width:220px; z-index:10000; background:rgba(25,25,28,.95); border:1px solid rgba(255,255,255,.12);
  border-radius:12px; padding:8px; box-shadow:0 24px 80px rgba(0,0,0,.65); backdrop-filter:blur(10px) }
.menu.show{ display:block }
.menu-item{ padding:8px 10px; border-radius:8px; font-size:13px; cursor:pointer; color:var(--text) }
.menu-item:hover{ background:rgba(255,255,255,.10) }
.menu hr{ border:none; height:1px; background:rgba(255,255,255,.12); margin:6px 0 }
.menu select{ width:100%; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); border-radius:8px; padding:6px 8px; color:var(--text) }

/* ===== Suggestions (stable, under searchbar, no layout shift) ===== */
.suggest{
  position:absolute;
  left:0; right:0;
  top: calc(100% + 8px); /* sits right below .searchbar */
  background:rgba(20,20,22,.98);
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px; padding:6px;
  box-shadow:0 24px 80px rgba(0,0,0,.65);
  display:none; max-height:360px; overflow:auto; z-index:50;
}
.suggest.show{ display:block }
.s-item{ padding:10px 12px; border-radius:12px; cursor:pointer; transition:background .15s; color:#EDEDED; font-size:14px }
.s-item:hover,.s-item.active{ background:rgba(255,255,255,.10) }

/* ===== Tabs + chips + pager ===== */
.chips-wrap{ display:flex; flex-direction:column; gap:10px }
.tabs{ display:flex; gap:8px; flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:4px;
  mask-image: linear-gradient(90deg, transparent, #000 12px, #000 calc(100% - 12px), transparent) }
.tabs::-webkit-scrollbar{ display:none }
.tab{ padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06) }
.tab.active{ box-shadow:0 0 0 2px var(--ring) inset; background:rgba(255,255,255,.14) }

/* Chips grid: auto-adjust, dense packing to avoid page break feel */
.chips{
  display:grid;
  grid-template-columns:repeat(6,1fr); /* keep repeat() for JS column counting */
  gap:10px; margin-top:4px;
  overflow:visible;                 /* avoid inner scrollbars that shift layout */
  align-content:start; grid-auto-rows:max-content;
  grid-auto-flow: row dense;        /* pack items tightly */
}
@media (max-width:1080px){ .chips{ grid-template-columns:repeat(4,1fr) } }
@media (max-width:640px){ .chips{ grid-template-columns:repeat(3,1fr); gap:8px } }

.chip{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:14px; text-decoration:none; color:var(--text);
  background:rgba(255,255,255,.09);
  border:1px solid rgba(255,255,255,.12); transition:transform .12s, background .15s, border .15s; align-self:start;
  min-height:44px;                 /* stable row height for JS height lock */
  min-width:0;                     /* prevent overflow from long titles */
  white-space:nowrap;
}
.chip:hover{ transform:translateY(-2px); background:rgba(255,255,255,.14); border-color:rgba(255,255,255,.22) }
.chip img{ width:20px; height:20px; border-radius:6px; object-fit:cover; flex:0 0 auto; }
.chip span{ font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; }

.pager{ display:flex; align-items:center; justify-content:center; gap:6px; margin-top:6px; flex-wrap:wrap }
.page-btn{ padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--text); font-size:12px; cursor:pointer }
.page-btn[disabled]{ opacity:.4; cursor:not-allowed }
.dot{ width:9px; height:9px; border-radius:50%; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08) }
.dot.active{ background:#a78bfa; border-color:#a78bfa }

/* ===== Footer ===== */
footer{ position:fixed; left:0; right:0; bottom:8px; text-align:center; color:var(--muted); font-size:12px }

/* ===== Modal (category sections with children) ===== */
.modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:9999; padding:20px }
.modal.show{ display:grid }
.modal-card{ width:min(980px,96vw); background:rgba(30,30,34,.8); border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:var(--shadow-1); backdrop-filter:blur(16px); padding:16px }
.modal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; gap:10px }
.modal-title{ font-weight:800; font-size:16px }
.modal-actions{ display:flex; gap:8px; flex-wrap:wrap }
.btn{ border:none; border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:700 }
.btn-primary{ background:linear-gradient(90deg,#a78bfa,#60a5fa); color:#0b0b0b; box-shadow:0 8px 24px rgba(96,165,250,.35) }
.btn-outline{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text) }

.section-list{ max-height:70vh; overflow:auto; display:grid; gap:12px }
.cat-section{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); border-radius:14px; }
.cat-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08) }
.cat-title{ font-weight:800 }
.cat-ops{ display:flex; gap:6px }
.mini{ border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.07); color:var(--text); border-radius:10px; padding:6px 8px; cursor:pointer; font-size:12px }
.mini:hover{ background:rgba(255,255,255,.14) }

.rows{ display:grid; gap:8px; padding:10px 12px }
.row{ display:grid; grid-template-columns: 1fr 2fr auto; gap:8px; align-items:center; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:8px }
.row input{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:var(--text); outline:none }
.row .ops{ display:flex; gap:6px }

</style>
</head>
<body>
  <div class="stellar" aria-hidden="true"></div>

  <!-- kebab -->
  <button id="kebab" class="kebab" aria-haspopup="true" aria-expanded="false">⋮</button>
  <div id="topMenu" class="menu" role="menu" aria-hidden="true">
    <div id="mngShortcuts" class="menu-item">Manage Shortcuts & Categories</div>
    <div id="changeName" class="menu-item">Change Name</div>
    <hr>
    <div class="menu-item">Per Page
      <div style="margin-top:6px;">
        <select id="perPageMenu"><option>12</option><option selected>24</option><option>36</option><option>48</option></select>
      </div>
    </div>
    <hr>
    <div id="downloadJSON" class="menu-item">Download JSON</div>
    <label class="menu-item" style="display:block; cursor:pointer;">Upload JSON
      <input id="fileUploadMenu" type="file" accept=".json,application/json" style="display:none;">
    </label>
    <div id="resetAll" class="menu-item">Reset to Defaults</div>
  </div>

  <div class="stage">
    <div class="stack">
      <h1 class="greet" id="greet">Good morning, Samiran</h1>

      <div class="content">
        <!-- left clock -->
        <section class="card clock-card pane" aria-live="polite">
          <div class="dial-wrap"><canvas id="dial" width="400" height="400" aria-label="Analog Clock"></canvas></div>
          <div id="digital" class="digital">--:--:--</div>
          <div id="date" class="date">Loading date…</div>
        </section>

        <!-- right: search + chips -->
        <section class="card panel pane">
          <div class="searchbar">
            <div class="field">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M11 3a8 8 0 015.9 13.3l3.8 3.8-1.4 1.4-3.8-3.8A8 8 0 1111 3z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
              <form id="searchForm" action="https://www.google.com/search" method="GET" target="_blank" autocomplete="off" role="search" style="display:contents">
                <input id="q" name="q" type="text" placeholder="Search Google…" aria-label="Search Google" />
                <button class="ai-btn" type="submit">Search</button>
              </form>
            </div>
            <div id="suggestions" class="suggest" role="listbox" aria-label="Search suggestions"></div>
          </div>

          <div class="chips-wrap">
            <div id="tabs" class="tabs" role="tablist" aria-label="Shortcut categories"></div>
            <div class="chips" id="chips"></div>
            <div class="pager" id="pager" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <footer>Made for you · fast, clean, minimal.</footer>

  <!-- Modal: category sections -->
  <div id="scModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="scTitle">
      <div class="modal-head">
        <div id="scTitle" class="modal-title">Manage Shortcuts & Categories</div>
        <div class="modal-actions">
          <button id="addCategory" class="btn btn-outline" type="button">+ Add Category</button>
          <button id="scSave" class="btn btn-primary" type="button">Save</button>
          <button id="scClose" class="btn btn-outline" type="button">Close</button>
        </div>
      </div>
      <div id="sectionList" class="section-list"></div>
    </div>
  </div>

<script>
/* ===== Greeting name ===== */
const NAME_KEY='HOMEPAGE_NAME';
function getName(){ return localStorage.getItem(NAME_KEY)||'Samiran'; }
function setName(n){ localStorage.setItem(NAME_KEY,n); }
(function(){
  const el=document.getElementById('greet');
  function setGreeting(){
    const h=new Date().getHours();
    let phrase='Hello'; if(h>=5&&h<12)phrase='Good morning'; else if(h>=12&&h<17)phrase='Good afternoon'; else if(h>=17&&h<21)phrase='Good evening'; else phrase='Good night';
    el.textContent=`${phrase}, ${getName()}`;
  }
  setGreeting(); setInterval(setGreeting,60000);
})();

/* ===== Keys ===== */
const LS_SHORTCUTS='CUSTOM_SHORTCUTS_V3';
const LS_CATS='CUSTOM_SHORTCUTS_CATS_V1';
const LS_UI='SHORTCUTS_UI_STATE';

/* ===== Defaults ===== */
const DEFAULT_CATEGORIES=['Google','Dev','Work','Social','AI','Other'];
const DEFAULT_SHORTCUTS=[
  {title:"Ads",url:"https://ads.google.com/",category:"Google"},
  {title:"Ad Manager",url:"https://admanager.google.com/",category:"Google"},
  {title:"AdSense",url:"https://adsense.google.com/",category:"Google"},
  {title:"Analytics",url:"https://analytics.google.com/",category:"Google"},
  {title:"Android",url:"https://www.android.com/",category:"Google"},
  {title:"Android Auto",url:"https://www.android.com/auto/",category:"Google"},
  {title:"Android Developers",url:"https://developer.android.com/",category:"Google"},
  {title:"Arts & Culture",url:"https://artsandculture.google.com/",category:"Google"},
  {title:"Blogger",url:"https://www.blogger.com/",category:"Google"},
  {title:"Books",url:"https://books.google.com/",category:"Google"},
  {title:"Calendar",url:"https://calendar.google.com/",category:"Google"},
  {title:"Chat",url:"https://chat.google.com/",category:"Google"},
  {title:"Classroom",url:"https://classroom.google.com/",category:"Google"},
  {title:"Cloud Console",url:"https://console.cloud.google.com/",category:"Google"},
  {title:"Cloud Docs",url:"https://cloud.google.com/docs",category:"Google"},
  {title:"Colab",url:"https://colab.research.google.com/",category:"Google"},
  {title:"Contacts",url:"https://contacts.google.com/",category:"Google"},
  {title:"Domains",url:"https://domains.google/",category:"Google"},
  {title:"Drive",url:"https://drive.google.com/",category:"Google"},
  {title:"Docs",url:"https://docs.google.com/",category:"Google"},
  {title:"Earth",url:"https://earth.google.com/web/",category:"Google"},
  {title:"Fi",url:"https://fi.google.com/",category:"Google"},
  {title:"Finance",url:"https://finance.google.com/",category:"Google"},
  {title:"Flights",url:"https://www.google.com/flights",category:"Google"},
  {title:"Forms",url:"https://forms.google.com/",category:"Google"},
  {title:"Gmail",url:"https://mail.google.com/",category:"Google"},
  {title:"Jamboard",url:"https://jamboard.google.com/",category:"Google"},
  {title:"Keep",url:"https://keep.google.com/",category:"Google"},
  {title:"Maps",url:"https://maps.google.com/",category:"Google"},
  {title:"Meet",url:"https://meet.google.com/",category:"Google"},
  {title:"Messages Web",url:"https://messages.google.com/web",category:"Google"},
  {title:"News",url:"https://news.google.com/",category:"Google"},
  {title:"Pay/Wallet",url:"https://wallet.google/",category:"Google"},
  {title:"Photos",url:"https://photos.google.com/",category:"Google"},
  {title:"Play Store",url:"https://play.google.com/",category:"Google"},
  {title:"Scholar",url:"https://scholar.google.com/",category:"Google"},
  {title:"Search Console",url:"https://search.google.com/search-console",category:"Google"},
  {title:"Sheets",url:"https://sheets.google.com/",category:"Google"},
  {title:"Sites",url:"https://sites.google.com/",category:"Google"},
  {title:"Slides",url:"https://slides.google.com/",category:"Google"},
  {title:"Tag Manager",url:"https://tagmanager.google.com/",category:"Google"},
  {title:"Tasks",url:"https://tasks.google.com/",category:"Google"},
  {title:"Translate",url:"https://translate.google.com/",category:"Google"},
  {title:"Travel",url:"https://www.google.com/travel/",category:"Google"},
  {title:"Trends",url:"https://trends.google.com/",category:"Google"},
  {title:"Voice",url:"https://voice.google.com/",category:"Google"},
  {title:"YouTube",url:"https://www.youtube.com/",category:"Google"},
  {title:"YouTube Music",url:"https://music.youtube.com/",category:"Google"},
  {title:"YouTube TV",url:"https://tv.youtube.com/",category:"Google"},
  {title:"GitHub",url:"https://github.com/",category:"Dev"},
  {title:"Stack Overflow",url:"https://stackoverflow.com/",category:"Dev"},
  {title:"MDN",url:"https://developer.mozilla.org/",category:"Dev"},
  {title:"Vercel",url:"https://vercel.com/",category:"Dev"},
  {title:"Twitter/X",url:"https://x.com/",category:"Social"},
  {title:"LinkedIn",url:"https://www.linkedin.com/",category:"Social"}
].sort((a,b)=>a.title.localeCompare(b.title));

/* ===== Helpers & store ===== */
function normalizeItem(x){
  const title=String(x.title||'').trim();
  const url=String(x.url||'').trim();
  let category=String(x.category||'').trim();
  if(!category){
    try{
      const h=new URL(url).hostname;
      if(/google|youtube|ytimg/.test(h)) category='Google';
      else if(/github|stack(over)?flow|npmjs|vercel|cloudflare|gitlab|bitbucket|netlify/.test(h)) category='Dev';
      else if(/linkedin|twitter|x\.com|facebook|instagram/.test(h)) category='Social';
      else category='Other';
    }catch{ category='Other'; }
  }
  return {title,url,category};
}
function readShortcuts(){ try{ const j=localStorage.getItem(LS_SHORTCUTS); if(!j) return null; const a=JSON.parse(j); return Array.isArray(a)?a.map(normalizeItem):null }catch{return null} }
function writeShortcuts(a){ localStorage.setItem(LS_SHORTCUTS, JSON.stringify(a)) }
function readCats(){ try{ const j=localStorage.getItem(LS_CATS); if(!j) return null; const a=JSON.parse(j); return Array.isArray(a)?a:null }catch{return null} }
function writeCats(a){ localStorage.setItem(LS_CATS, JSON.stringify(a)) }
function readUI(){ try{ const u=JSON.parse(localStorage.getItem(LS_UI))||{tab:'Google',page:0,perPage:24}; if(!u.perPage) u.perPage=24; return u }catch{ return {tab:'Google',page:0,perPage:24} } }
function writeUI(u){ localStorage.setItem(LS_UI, JSON.stringify(u)) }
function faviconFor(u){ try{ return `https://www.google.com/s2/favicons?sz=64&domain=${new URL(u).hostname}` }catch{ return `https://www.google.com/s2/favicons?sz=64&domain=google.com` } }

/* ===== State ===== */
let shortcuts = readShortcuts() || DEFAULT_SHORTCUTS.slice();
let categories = readCats() || DEFAULT_CATEGORIES.slice();
let ui = readUI();

/* ===== Tabs + chips + pager (height fixed by capacity) ===== */
const tabsRoot=document.getElementById('tabs');
const chipsRoot=document.getElementById('chips');
const pagerRoot=document.getElementById('pager');

function allCategoriesOrdered(){ // "All" + user order + unseen
  const seen=new Set(categories);
  const fromData=[...new Set(shortcuts.map(s=>s.category))].filter(c=>!seen.has(c));
  return ['All', ...categories, ...fromData];
}

function renderTabs(){
  tabsRoot.innerHTML='';
  allCategoriesOrdered().forEach(cat=>{
    const b=document.createElement('button');
    b.className='tab'+(ui.tab===cat?' active':''); b.textContent=cat; b.type='button';
    b.addEventListener('click',()=>{ ui.tab=cat; ui.page=0; writeUI(ui); renderChipsAndPager(); renderTabs(); });
    tabsRoot.appendChild(b);
  });
}

function listForTab(){
  let list=shortcuts.slice();
  if(ui.tab && ui.tab!=='All') list=list.filter(s=>s.category===ui.tab);
  list.sort((a,b)=>a.title.localeCompare(b.title));
  return list;
}

function getGridColumnsCount(el){
  const g=getComputedStyle(el).gridTemplateColumns.trim();
  const m=g.match(/^repeat\(\s*(\d+)\s*,/i);
  if(m) return parseInt(m[1],10);
  if(g==='none'||!g) return 1;
  const safe=g.replace(/minmax\([^)]*\)/g,'X').replace(/\(.*?\)/g,'X');
  return safe.split(/\s+/).filter(Boolean).length||1;
}

function lockChipsHeight(PER_PAGE){
  const cols=Math.max(1,getGridColumnsCount(chipsRoot));
  const rows=Math.max(1,Math.ceil(PER_PAGE/cols));
  let sample=chipsRoot.querySelector('.chip'); let remove=false;
  if(!sample){ sample=document.createElement('a'); sample.className='chip'; sample.style.visibility='hidden'; sample.innerHTML='<img width="20" height="20"><span>Sample</span>'; chipsRoot.appendChild(sample); remove=true; }
  const chipH=sample.getBoundingClientRect().height||44;
  const gap=parseFloat(getComputedStyle(chipsRoot).gap)||10;
  const total=rows*chipH + (rows-1)*gap;
  chipsRoot.style.minHeight=Math.round(total)+'px';
  if(remove) sample.remove();
}

function renderChipsAndPager(){
  const list=listForTab();
  const PER_PAGE=Math.max(1,parseInt(ui.perPage||24,10));
  const totalPages=Math.max(1,Math.ceil(list.length/PER_PAGE));
  if(ui.page>totalPages-1) ui.page=totalPages-1;
  if(ui.page<0) ui.page=0;

  const start=ui.page*PER_PAGE;
  const pageItems=list.slice(start,start+PER_PAGE);

  chipsRoot.innerHTML='';
  pageItems.forEach(s=>{
    const a=document.createElement('a');
    a.className='chip'; a.href=s.url; a.target='_blank'; a.rel='noopener';
    a.dataset.url=s.url; a.dataset.title=s.title; a.dataset.category=s.category;
    a.innerHTML=`<img loading="lazy" src="${faviconFor(s.url)}" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?sz=64&domain=google.com';"><span>${s.title}</span>`;
    chipsRoot.appendChild(a);
  });

  lockChipsHeight(PER_PAGE); // height fixed by capacity

  pagerRoot.innerHTML='';
  if(totalPages>1){
    const prev=document.createElement('button'); prev.className='page-btn'; prev.textContent='Prev'; prev.disabled=ui.page===0;
    prev.addEventListener('click',()=>{ ui.page--; writeUI(ui); renderChipsAndPager(); });
    pagerRoot.appendChild(prev);
    for(let i=0;i<totalPages;i++){
      const d=document.createElement('div'); d.className='dot'+(i===ui.page?' active':''); d.title=`Page ${i+1}`; d.style.cursor='pointer';
      d.addEventListener('click',()=>{ ui.page=i; writeUI(ui); renderChipsAndPager(); });
      pagerRoot.appendChild(d);
    }
    const next=document.createElement('button'); next.className='page-btn'; next.textContent='Next'; next.disabled=ui.page===totalPages-1;
    next.addEventListener('click',()=>{ ui.page++; writeUI(ui); renderChipsAndPager(); });
    pagerRoot.appendChild(next);
  }
}

function renderAll(){ renderTabs(); renderChipsAndPager(); }
renderAll();

let rsId; window.addEventListener('resize',()=>{ clearTimeout(rsId); rsId=setTimeout(()=>lockChipsHeight(Math.max(1,parseInt(ui.perPage||24,10))),120); });

/* ===== Clock (12h) ===== */
(function(){
  const canvas=document.getElementById('dial'), ctx=canvas.getContext('2d');
  const digital=document.getElementById('digital'), dateEl=document.getElementById('date');
  const DPR=Math.max(1,window.devicePixelRatio||1);
  function pad(n){return String(n).padStart(2,'0');}
  function to12(h){ const hh=h%12||12; const ampm=h<12?'AM':'PM'; return {hh,ampm}; }
  function fit(){ const css=Math.min(canvas.clientWidth,canvas.clientHeight||canvas.clientWidth); const px=Math.floor(css*DPR); canvas.width=px; canvas.height=px; }
  function draw(){
    fit();
    const w=canvas.width,h=canvas.height,r=Math.min(w,h)/2-22*DPR,cx=w/2,cy=h/2;
    ctx.clearRect(0,0,w,h); ctx.save(); ctx.translate(cx,cy);
    const g=ctx.createRadialGradient(0,0,r*.15,0,0,r); g.addColorStop(0,'rgba(255,255,255,.10)'); g.addColorStop(1,'rgba(255,255,255,.02)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth=6*DPR; ctx.strokeStyle='rgba(255,255,255,.18)'; ctx.beginPath(); ctx.arc(0,0,r-ctx.lineWidth/2,0,Math.PI*2); ctx.stroke();
    for(let i=0;i<60;i++){ const a=i*Math.PI/30,long=i%5===0,len=long?r*.1:r*.05;
      ctx.lineWidth=(long?3.6:1.6)*DPR; ctx.strokeStyle=long?'rgba(255,255,255,.9)':'rgba(255,255,255,.5)';
      ctx.beginPath(); ctx.moveTo((r-len)*Math.cos(a),(r-len)*Math.sin(a)); ctx.lineTo((r-8*DPR)*Math.cos(a),(r-8*DPR)*Math.sin(a)); ctx.stroke();
    }
    const now=new Date(),hr=now.getHours()%12,min=now.getMinutes(),sec=now.getSeconds(),ms=now.getMilliseconds();
    const aS=((sec+ms/1000)*Math.PI/30)-Math.PI/2, aM=((min+sec/60)*Math.PI/30)-Math.PI/2, aH=((hr+min/60)*Math.PI/6)-Math.PI/2;
    ctx.lineCap='round';
    ctx.strokeStyle='rgba(255,255,255,.96)'; ctx.lineWidth=6*DPR; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(r*.5*Math.cos(aH),r*.5*Math.sin(aH)); ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=4*DPR; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(r*.75*Math.cos(aM),r*.75*Math.sin(aM)); ctx.stroke();
    ctx.strokeStyle='rgba(167,123,255,.95)'; ctx.lineWidth=2*DPR; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(r*.85*Math.cos(aS),r*.85*Math.sin(aS)); ctx.stroke();
    const nowFull=new Date(); const h24=nowFull.getHours(); const {hh,ampm}=to12(h24);
    digital.textContent=`${pad(hh)}:${pad(nowFull.getMinutes())}:${pad(nowFull.getSeconds())} ${ampm}`;
    dateEl.textContent=nowFull.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:'numeric'});
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

/* ===== Google Suggest (JSONP) + local fallback ===== */
const q=document.getElementById('q'), form=document.getElementById('searchForm'), list=document.getElementById('suggestions');
let jsonp, jsonpTimer;
const STATIC_SUGGEST=['weather today','time in tokyo','latest ai news','javascript array methods','css grid examples','react hooks guide','tailwind cheatsheet','web accessibility'];

function localBank(){
  const set=new Set();
  (shortcuts||[]).forEach(s=>{
    if(s.title) set.add(s.title);
    try{ set.add(new URL(s.url).hostname.replace(/^www\./,'')); }catch{}
  });
  STATIC_SUGGEST.forEach(x=>set.add(x));
  return Array.from(set);
}
let LOCAL=localBank();

function renderList(items,query){
  list.innerHTML='';
  if(!items.length){ list.classList.remove('show'); return; }
  const go=document.createElement('div');
  go.className='s-item';
  go.innerHTML=`Search Google for “${(query||'').replace(/</g,'&lt;')}”`;
  go.addEventListener('mousedown',e=>{ e.preventDefault(); form.submit(); });
  list.appendChild(go);
  items.slice(0,9).forEach(txt=>{
    const el=document.createElement('div');
    el.className='s-item'; el.textContent=txt;
    el.addEventListener('mousedown',e=>{ e.preventDefault(); q.value=txt; list.classList.remove('show'); form.submit(); });
    list.appendChild(el);
  });
  list.classList.add('show');
}

function suggestJSONP(v){
  if(jsonp) document.body.removeChild(jsonp);
  clearTimeout(jsonpTimer);
  jsonpTimer=setTimeout(()=>{
    const t=v.trim().toLowerCase();
    const loc=LOCAL.filter(s=>s.toLowerCase().includes(t)).slice(0,8);
    renderList(loc,v);
  },350);
  jsonp=document.createElement('script');
  jsonp.src=`https://suggestqueries.google.com/complete/search?client=firefox&q=${encodeURIComponent(v)}&callback=showSuggest`;
  document.body.appendChild(jsonp);
}
window.showSuggest=function(data){
  clearTimeout(jsonpTimer);
  const items=(data&&data[1])?data[1]:[];
  if(!items.length){
    const v=q.value||''; const t=v.trim().toLowerCase();
    const loc=LOCAL.filter(s=>s.toLowerCase().includes(t)).slice(0,8);
    renderList(loc,v); return;
  }
  renderList(items, q.value||'');
};

let debounce;
q.addEventListener('input', ()=>{
  const v=q.value.trim();
  if(!v){ list.classList.remove('show'); return; }
  clearTimeout(debounce);
  debounce=setTimeout(()=>suggestJSONP(v),120);
});
q.addEventListener('focus', ()=>{
  if(!q.value.trim()){ list.classList.remove('show'); return; }
  suggestJSONP(q.value.trim());
});
q.addEventListener('blur', ()=> setTimeout(()=> list.classList.remove('show'), 140));
form.addEventListener('submit', e=>{ if(!q.value.trim()){ e.preventDefault(); q.focus(); } });

/* ===== Kebab menu ===== */
const kebab=document.getElementById('kebab'), topMenu=document.getElementById('topMenu'), perPageMenu=document.getElementById('perPageMenu');
perPageMenu.value=String(ui.perPage||24);
function closeKebab(){ topMenu.classList.remove('show'); topMenu.setAttribute('aria-hidden','true'); kebab.setAttribute('aria-expanded','false'); }
function openKebab(){ topMenu.classList.add('show'); topMenu.setAttribute('aria-hidden','false'); kebab.setAttribute('aria-expanded','true'); }
kebab.addEventListener('click',()=>{ topMenu.classList.contains('show')?closeKebab():openKebab(); });
document.addEventListener('click',e=>{ if(!topMenu.contains(e.target) && e.target!==kebab) closeKebab(); });

document.getElementById('changeName').addEventListener('click',()=>{
  const n=prompt('Your name for the greeting:', getName()); if(n==null) return;
  const cleaned=n.trim(); if(!cleaned) return alert('Name cannot be empty.');
  setName(cleaned);
  const h=new Date().getHours(); let phrase='Hello'; if(h>=5&&h<12)phrase='Good morning'; else if(h>=12&&h<17)phrase='Good afternoon'; else if(h>=17&&h<21)phrase='Good evening'; else phrase='Good night';
  document.getElementById('greet').textContent=`${phrase}, ${cleaned}`; closeKebab();
});
document.getElementById('mngShortcuts').addEventListener('click',()=>{ openModal(); closeKebab(); });
perPageMenu.addEventListener('change',()=>{ ui.perPage=parseInt(perPageMenu.value,10)||24; ui.page=0; writeUI(ui); renderChipsAndPager(); closeKebab(); });
document.getElementById('resetAll').addEventListener('click',()=>{
  if(!confirm('Reset ALL to defaults?')) return;
  localStorage.removeItem(LS_SHORTCUTS); localStorage.removeItem(LS_CATS);
  shortcuts=DEFAULT_SHORTCUTS.slice(); categories=DEFAULT_CATEGORIES.slice();
  ui={tab:'Google',page:0,perPage:24}; writeUI(ui); renderAll(); LOCAL=localBank(); closeKebab();
});
document.getElementById('downloadJSON').addEventListener('click',()=>{
  const payload={ categories:categories.slice(), shortcuts:(readShortcuts()||shortcuts).map(normalizeItem) };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shortcuts.json';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0); closeKebab();
});
document.getElementById('fileUploadMenu').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const t=await f.text(); const p=JSON.parse(t);
    if(Array.isArray(p)){ const cleaned=p.map(normalizeItem).filter(x=>x.title&&x.url); writeShortcuts(cleaned); shortcuts=cleaned; }
    else if(p && typeof p==='object'){
      if(Array.isArray(p.shortcuts)){ const cleaned=p.shortcuts.map(normalizeItem).filter(x=>x.title&&x.url); writeShortcuts(cleaned); shortcuts=cleaned; }
      if(Array.isArray(p.categories)){ const cats=p.categories.map(s=>String(s).trim()).filter(Boolean); if(cats.length){ writeCats(cats); categories=cats; } }
    } else throw new Error('Invalid JSON');
    ui.page=0; writeUI(ui); renderAll(); LOCAL=localBank(); alert('Imported successfully.');
  }catch(err){ alert('Import failed: '+(err?.message||'Invalid file')); }
  e.target.value=''; closeKebab();
});

/* ===== Modal: category sections (parent with children) ===== */
const modal=document.getElementById('scModal');
const sectionList=document.getElementById('sectionList');
const scClose=document.getElementById('scClose');
const scSave=document.getElementById('scSave');
const addCategory=document.getElementById('addCategory');

let workingShortcuts=[], workingCats=[];
function openModal(){
  workingShortcuts=(readShortcuts()||shortcuts.slice()).map(normalizeItem);
  workingCats=(readCats()||categories.slice()).map(String);
  drawSections();
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
scClose.addEventListener('click', closeModal);
modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });

function drawSections(){
  sectionList.innerHTML='';
  if(!workingCats.length){
    const empty=document.createElement('div'); empty.style.color='var(--muted)'; empty.textContent='No categories. Add one.';
    sectionList.appendChild(empty); return;
  }
  workingCats.forEach((cat,idx)=>{
    const wrap=document.createElement('div'); wrap.className='cat-section';
    wrap.innerHTML=`
      <div class="cat-head">
        <div class="cat-title">${cat}</div>
        <div class="cat-ops">
          <button class="mini" data-op="up" ${idx===0?'disabled':''}>↑</button>
          <button class="mini" data-op="down" ${idx===workingCats.length-1?'disabled':''}>↓</button>
          <button class="mini" data-op="rename">✎</button>
          <button class="mini" data-op="add">+ Add shortcut</button>
          <button class="mini" data-op="del">✕</button>
        </div>
      </div>
      <div class="rows"></div>
    `;
    const rows=wrap.querySelector('.rows');

    // rows for this cat
    const list=workingShortcuts.filter(s=>s.category===cat);
    if(!list.length){
      const d=document.createElement('div'); d.className='row';
      d.innerHTML=`<div style="grid-column:1/-1; color:var(--muted)">No shortcuts in “${cat}”.</div>`;
      rows.appendChild(d);
    }else{
      list.forEach((it,iInCat)=>{
        const realIdx=workingShortcuts.findIndex(s=>s===list[iInCat]);
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`
          <input type="text" value="${(it.title||'').replace(/"/g,'&quot;')}" placeholder="Title">
          <input type="url" value="${(it.url||'').replace(/"/g,'&quot;')}" placeholder="https://example.com">
          <div class="ops">
            <button class="mini" data-op="up">↑</button>
            <button class="mini" data-op="down">↓</button>
            <button class="mini" data-op="del">✕</button>
          </div>
        `;
        const [inpT,inpU]=row.querySelectorAll('input');
        inpT.addEventListener('input',e=>{ workingShortcuts[realIdx].title=e.target.value; });
        inpU.addEventListener('input',e=>{ workingShortcuts[realIdx].url=e.target.value; });
        row.querySelector('[data-op="up"]').addEventListener('click',()=>{
          const inCat=workingShortcuts.filter(s=>s.category===cat);
          if(iInCat>0){
            const a=realIdx, b=workingShortcuts.findIndex(s=>s===inCat[iInCat-1]);
            [workingShortcuts[a],workingShortcuts[b]]=[workingShortcuts[b],workingShortcuts[a]];
            drawSections();
          }
        });
        row.querySelector('[data-op="down"]').addEventListener('click',()=>{
          const inCat=workingShortcuts.filter(s=>s.category===cat);
          if(iInCat<inCat.length-1){
            const a=realIdx, b=workingShortcuts.findIndex(s=>s===inCat[iInCat+1]);
            [workingShortcuts[a],workingShortcuts[b]]=[workingShortcuts[b],workingShortcuts[a]];
            drawSections();
          }
        });
        row.querySelector('[data-op="del"]').addEventListener('click',()=>{
          workingShortcuts.splice(realIdx,1); drawSections();
        });
        rows.appendChild(row);
      });
    }

    // ops
    wrap.querySelector('[data-op="up"]').addEventListener('click',()=>{ if(idx>0){ [workingCats[idx-1],workingCats[idx]]=[workingCats[idx],workingCats[idx-1]]; drawSections(); }});
    wrap.querySelector('[data-op="down"]').addEventListener('click',()=>{ if(idx<workingCats.length-1){ [workingCats[idx+1],workingCats[idx]]=[workingCats[idx],workingCats[idx+1]]; drawSections(); }});
    wrap.querySelector('[data-op="rename"]').addEventListener('click',()=>{
      const n=prompt('Rename category:', cat); if(n==null) return; const cleaned=n.trim(); if(!cleaned) return;
      workingShortcuts.forEach(s=>{ if(s.category===cat) s.category=cleaned; });
      workingCats[idx]=cleaned; drawSections();
    });
    wrap.querySelector('[data-op="add"]').addEventListener('click',()=>{
      workingShortcuts.push({title:'New',url:'https://',category:cat}); drawSections();
    });
    wrap.querySelector('[data-op="del"]').addEventListener('click',()=>{
      if(!confirm(`Delete “${cat}”? You will move its shortcuts.`)) return;
      let dest=prompt(`Move items from “${cat}” to which category?\nExisting: ${workingCats.filter(c=>c!==cat).join(', ')}`,'Other');
      dest=(dest||'Other').trim(); if(!workingCats.includes(dest)) workingCats.push(dest);
      workingShortcuts.forEach(s=>{ if(s.category===cat) s.category=dest; });
      workingCats=workingCats.filter(c=>c!==cat); drawSections();
    });

    sectionList.appendChild(wrap);
  });
}

document.getElementById('addCategory').addEventListener('click',()=>{
  const n=prompt('New category name:','New Category'); if(n==null) return;
  const cleaned=n.trim(); if(!cleaned) return;
  if(!workingCats.includes(cleaned)) workingCats.push(cleaned);
  drawSections();
});

document.getElementById('scSave').addEventListener('click',()=>{
  const cleaned=workingShortcuts.map(normalizeItem).filter(x=>x.title && x.url);
  const catsClean=Array.from(new Set(workingCats.map(s=>s.trim()).filter(Boolean)));
  writeShortcuts(cleaned); writeCats(catsClean);
  shortcuts=cleaned; categories=catsClean;
  const tabs=['All',...categories]; if(!tabs.includes(ui.tab)) ui.tab='All';
  ui.page=0; writeUI(ui); renderAll();
  LOCAL=localBank();    // keep suggestions in sync
  closeModal();
});

/* ===== Kebab handlers already above ===== */
</script>
</body>
</html>
